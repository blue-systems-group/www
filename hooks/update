#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

LOCKFILE=$DIR/../deploy.lock
LOCKFD=99

_lock() {
  flock -$1 $LOCKFD;
}
_no_more_locking() {
  _lock u;
  _lock xn && rm -f $LOCKFILE && popd;
}
_prepare_locking() {
  eval "exec $LOCKFD>\"$LOCKFILE\"";
  trap _no_more_locking EXIT;
}
exlock_now() {
  _lock xn;
}

_prepare_locking
exlock_now || exit 0

pushd $DIR/../

git fetch origin
if ! [ -z "$1" ]; then
  git -c advice.detachedHead=false checkout $1
fi
git clean -df

npm install
if node ./lib/index.js . --check --deploy; then
  sudo mkdir -p /mnt/ramdisk/www.bluegroup.systems/
  sudo chown challen:challen /mnt/ramdisk/www.bluegroup.systems/
  rsync -crlpgoDi --delete .build/* /mnt/ramdisk/www.bluegroup.systems/
  sudo touch /mnt/ramdisk/nginx/pagespeed_cache/cache.flush
else
  echo "Build failed"
  exit 1
fi

# vim: ts=2:sw=2:et
