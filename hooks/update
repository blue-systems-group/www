#!/usr/bin/env bash

LOCKFILE="/home/git/www/blue.cse.buffalo.edu/deploy.lock"
LOCKFD=99

_lock()             { flock -$1 $LOCKFD; }
_no_more_locking()  { _lock u; _lock xn && rm -f $LOCKFILE; }
_prepare_locking()  { eval "exec $LOCKFD>\"$LOCKFILE\""; trap _no_more_locking EXIT; }

_prepare_locking

exlock_now()        { _lock xn; }

if ! [ -z "$1" ] && ! [ "refs/heads/deploy" == "$1" ]; then
  exit 1
fi

exlock_now || exit 0

NVM_DIR="/home/git/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm
export HOME="/home/git/"

WORK_TREE=$HOME/www/blue.cse.buffalo.edu/
if ! [ -z "$3" ]; then
  git --work-tree=$WORK_TREE checkout $3
fi
cd $WORK_TREE

echo "Building blue.cse.buffalo.edu..."
if make ; then
  rsync -ai build/* /mnt/ramdisk/blue.cse.buffalo.edu/www/ | while read unused filename; do
    curl --request PURGE 'http://127.0.0.1/$filename' > /dev/null 2> /dev/null
    echo "Updated $filename"
  done
  echo "Success. Thanks for updating the website."
else
  echo "Failed. Please try again."
  exit 1
fi
